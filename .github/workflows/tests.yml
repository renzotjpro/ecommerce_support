name: Tests and CI/CD

# Trigger the workflow on push or pull request to main branch
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  # Allow manual trigger
  workflow_dispatch:

# Cancel in-progress runs when a new run is triggered
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================
  # JOB 1: RUN TESTS
  # ============================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11']
    
    steps:
      # Step 1: Checkout code
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      # Step 2: Set up Python
      - name: ğŸ Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      
      # Step 3: Install dependencies
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio pytest-xdist
      
      # Step 4: Run linting (optional but recommended)
      - name: ğŸ” Lint with flake8
        run: |
          pip install flake8
          # Stop the build if there are Python syntax errors or undefined names
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # Treat all errors as warnings
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
        continue-on-error: true
      
      # Step 5: Run tests with coverage
      - name: ğŸ§ª Run tests
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          pytest tests/ -v --cov=. --cov-report=xml --cov-report=term-missing
      
      # Step 6: Upload coverage to Codecov
      - name: ğŸ“Š Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
      
      # Step 7: Generate coverage badge (only on Python 3.11)
      - name: ğŸ… Generate coverage badge
        if: matrix.python-version == '3.11'
        run: |
          pip install coverage-badge
          coverage-badge -o coverage.svg -f
      
      # Step 8: Upload coverage badge as artifact
      - name: ğŸ“¤ Upload coverage badge
        if: matrix.python-version == '3.11'
        uses: actions/upload-artifact@v3
        with:
          name: coverage-badge
          path: coverage.svg

  # ============================================
  # JOB 2: CODE QUALITY CHECKS
  # ============================================
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: ğŸ“¦ Install quality tools
        run: |
          pip install black isort pylint bandit
      
      # Check code formatting with Black
      - name: ğŸ¨ Check code formatting (Black)
        run: |
          black --check .
        continue-on-error: true
      
      # Check import sorting
      - name: ğŸ“š Check import sorting (isort)
        run: |
          isort --check-only .
        continue-on-error: true
      
      # Run pylint
      - name: ğŸ” Run pylint
        run: |
          pylint **/*.py --exit-zero
        continue-on-error: true
      
      # Security check with bandit
      - name: ğŸ”’ Security check (Bandit)
        run: |
          bandit -r . -ll -x ./tests,./venv,./.venv
        continue-on-error: true

  # ============================================
  # JOB 3: DEPENDENCY SECURITY SCAN
  # ============================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: ğŸ”’ Run safety check
        run: |
          pip install safety
          safety check --json || true
        continue-on-error: true

  # ============================================
  # JOB 4: BUILD CHECK
  # ============================================
  build:
    name: Build Check
    runs-on: ubuntu-latest
    needs: [test, code-quality]
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: âœ… Verify installation
        run: |
          python -c "import database; print('âœ… Database module imported successfully')"
          python -c "import tools; print('âœ… Tools module imported successfully')"
          python -c "import agents_config; print('âœ… Agents config imported successfully')"
      
      - name: ğŸ¯ Test basic functionality
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          python -c "from database import OrderDatabase; db = OrderDatabase(); print('âœ… Database connection successful')"

  # ============================================
  # JOB 5: DEPLOY TO HUGGING FACE (Optional)
  # ============================================
  deploy-huggingface:
    name: Deploy to Hugging Face
    runs-on: ubuntu-latest
    needs: [test, build]
    # Only deploy on push to main branch
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true
      
      - name: ğŸš€ Push to Hugging Face Spaces
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          
          # Add Hugging Face remote (if not exists)
          git remote add huggingface https://YOUR_USERNAME:$HF_TOKEN@huggingface.co/spaces/YOUR_USERNAME/ecommerce-support || true
          
          # Push to Hugging Face
          git push huggingface main --force

  # ============================================
  # JOB 6: CREATE RELEASE (On Tag)
  # ============================================
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [test, build]
    # Only run on version tags
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ“ Create Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          draft: false
          prerelease: false

  # ============================================
  # JOB 7: NOTIFICATION (Optional)
  # ============================================
  notify:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [test, code-quality, build]
    if: failure()
    
    steps:
      - name: ğŸ“§ Send notification
        run: |
          echo "Tests failed! Check the logs."
          # Add your notification logic here (Slack, Discord, Email, etc.)

# ============================================
# WORKFLOW SUMMARY
# ============================================
# This workflow:
# 1. âœ… Runs tests on multiple Python versions
# 2. ğŸ“Š Generates coverage reports
# 3. ğŸ¨ Checks code quality and formatting
# 4. ğŸ”’ Scans for security vulnerabilities
# 5. ğŸ—ï¸ Verifies the build works
# 6. ğŸš€ (Optional) Deploys to Hugging Face on main branch
# 7. ğŸ“¦ (Optional) Creates releases on version tags